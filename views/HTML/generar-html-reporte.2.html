<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.ibb.co/RSDPTVP/logoregistel-copia.png">

    <script src="https://cdn.jsdelivr.net/gh/Jeff-Aporta/main@master/00Libs/Lightbox/2/lightbox2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.0/dist/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
</head>

<body>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
        }

        .miniatura {
            width: 150px;
            height: 150px;
            object-fit: contain;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            cursor: pointer;
            margin: 10px;
            border: 2px solid navy;
            transition: all 0.2s;
        }

        .miniatura:hover {
            transform: scale(1.05);
        }

        .tab-content {
            padding: 20px;
        }

        .nav-link {
            font-weight: bolder;
            color: #2967bd;
        }

        #main-content td {
            border: 1px solid rgba(0, 0, 0, 0.3);
            padding: 10px;
        }

        #main-content table {
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid white !important;
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.2);
        }

        #main-tabs {
            position: sticky;
            z-index: 10;
            padding-top: 10px;
            background: white;
            top: 0;
            left: 0;
        }

        .nav-link {
            font-size: 80%;
        }
    </style>
    <div style="
            position: relative;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
            padding: 50px;
            color: #1F4E8E;
        ">

        <div style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: -10;">
            <img src="https://i.ibb.co/sjFtsgt/output-onlinegiftools.gif"
                style="opacity: 0.3;position: absolute;top: 0;left: 0;width: 100%;height: 100%;object-fit: cover;;z-index: -9;">
            <div
                style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: -8;background: linear-gradient(to bottom, transparent, white);">
            </div>
        </div>

        <div style="display: flex;justify-content: space-between;align-items: center;">
            <img src="https://docs.google.com/drawings/d/e/2PACX-1vQx6kPeKeeXNmC80XxA4uMvvhudYesQXR-4yq0DUxfDR79aVertoU-jT_-NCSNzalpqvY0r9gSk5p4o/pub?w=200"
                style="width: 150px;height: 150px;margin:0 30px;border: 2px solid black;object-fit: cover;">
            <div>
                <h1>
                    Reportes de casos
                </h1>
                <h3>
                    Jeffrey Alexander
                    <br>
                    Agudelo Espitia
                </h3>
                <h5>
                    Ingeniero de software
                </h5>
            </div>
        </div>
        <div style="text-align: right;">
            <img src="https://i.ibb.co/CK1yV01/logoregistel.png"
                style="max-width: 300px;max-height: 300px;margin:0 30px;">
            <div id="fecha-reporte" style="color: #2260b6;font-weight: bolder;"></div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="main-tabs" role="tablist">
    </ul>
    <div class="tab-content" id="main-content" style="background-color: whitesmoke;">
    </div>


    <div id="controles" style="position: fixed;right: 10px;bottom: 10px;">
        <div style="
                background:dodgerblue;
                width:60px;
                height:60px;
                border-radius:50%;
                color:white;
                display:flex;
                justify-content:space-evenly;
                align-items:center;
                cursor:pointer;
                margin: 5px;
            " onclick="descargarWordFechas()">
            <i class="fa-solid fa-file-word"></i>
            DOC
        </div>
        <div style="
                background:rgb(255, 184, 30);
                width:50px;
                height:50px;
                border-radius:50%;
                color:white;
                display:flex;
                justify-content:center;
                align-items:center;
                cursor:pointer;
                margin: 5px;
            " onclick="download()">
            <i class="fa-solid fa-file-code"></i>
            HTML
        </div>
    </div>


    <script>
        let dev = true;
        let proyectos = []

        if (dev) {
            let fecha = new Date().getFullYear() + "/" + ((new Date().getMonth() + 1) + "").padStart(2, 0) + "/" + (new Date().getDate() + "").padStart(2, 0)
            document.getElementById("fecha-reporte").innerHTML = fecha
            document.title = "Reporte de casos - " + fecha
        }

        lightbox_update_style({
            background: "rgba(0, 0, 0, 0.5)",
            background2: "transparent",
            colorBorder: "transparent",
            colorButtons: "white",
        });

        function download(text) {
            var element = document.createElement('a');
            element.setAttribute(
                'href',
                'data:text/plain;charset=utf-8,%EF%BB%BF' + encodeURIComponent(
                    document.documentElement.outerHTML
                        .replaceAll(`let dev = true;`, `let dev = false;`)
                )
            );
            let nombre = document.querySelectorAll("button.active")[0].innerText + " - Reporte de casos - Jeffrey Agudelo" + ".html"
            nombre = nombre.replaceAll(" ", "-").toLowerCase()
            element.setAttribute('download', nombre);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        generarReporte()

        async function generarReporte() {
            document.getElementById("controles").style.display = "none"
            if (dev) {
                try {
                    let URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuZC7Vg7vtGzEaLVTTvV7lkRQzxduxPJQfVcrUqoaBJq_xEkQMnCAJUEl37xOWsIOgM-57uw-lcFV9/pub?gid=0&single=true&output=tsv";
                    let consulta = await fetch(URL);
                    let texto = await consulta.text();
                    texto = texto.replaceAll("\r", "")
                    let renglones = texto.split("\n");

                    proyectos = renglones.map(renglon => renglon.split("\t"))
                        .filter(elementos => elementos[0] == "REPORTE!")
                        .map(elementos => { return { nombre: elementos[1], introduccion: elementos[2], subreportes: [] } });

                    let html_tabs = ``
                    proyectos.forEach((proyecto, index) => {
                        let id = proyecto.nombre.replaceAll(" ", "-").toLowerCase();
                        proyecto.id = id;
                        html_tabs += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${index == 0 ? "active" : ""}" id="tab-${id}" data-bs-toggle="tab" data-bs-target="#content-${id}" type="button"
                                role="tab" aria-controls="content-${id}" aria-selected="true">
                                ${proyecto.nombre}
                            </button>
                        </li>
                    `;
                    })
                    document.getElementById("main-tabs").innerHTML = html_tabs

                    let buscarReporte = true;
                    let reportes = []
                    let html_content = ``

                    let n_reporte = ""

                    renglones.map(renglon => renglon.split("\t")).forEach(elementos => {
                        if (elementos[0] == "REPORTE!") {
                            n_reporte = elementos[1];
                        } else {
                            let [caso, descripcion, imagenes, comentarios, estado, fecha, peticion] = elementos;
                            if (caso == "caso") {
                                return;
                            }
                            imagenes = imagenes.split(";");
                            proyectos.find(proyecto => proyecto.nombre == n_reporte)
                                .subreportes.push({ caso, descripcion, imagenes, comentarios, estado, fecha, peticion })
                        }
                    })

                    proyectos.forEach((proyecto, index_proyecto) => {

                        html_content += `<div class="tab-pane fade ${index_proyecto == 0 ? "show active" : ""}" id="content-${proyecto.id}" role="tabpanel" aria-labelledby="tab-${proyecto.id}">`

                        html_content += `
                        <br>
                        <h1 style="text-align:center;">
                            ${proyecto.nombre}
                        </h1>
                        <br>
                        ${proyecto.introduccion}
                        <br>
                        <hr>
                        <br>
                    `
                        proyecto.subreportes.reverse()
                        proyecto.subreportes.forEach((reporte, index) => {
                            let g = ((proyecto.subreportes.length - index) + "").padStart(3, 0)
                            html_content += `
                        <table style="width: 100%;background: white;">
                            <colgroup>
                                <col style="width:150px;">
                            </colgroup>
                            <tbody>
                                <tr style="background-color: royalblue;color: white;">
                                    <td class="reporte">
                                        <strong>
                                            Reporte ${g}
                                        </strong>
                                    </td>
                                    <td class="caso">
                                        <strong style="text-transform:uppercase;">
                                            ${reporte.caso}
                                        </strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>
                                            Petición
                                        </strong>
                                    </td>
                                    <td class="peticion">
                                        <strong>
                                            ${reporte.peticion}
                                        </strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>
                                            Descripción
                                        </strong>
                                    </td>
                                    <td class="descripcion">
                                        ${reporte.descripcion}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>
                                            Comentarios
                                        </strong>
                                    </td>
                                    <td class="comentarios">
                                        ${reporte.comentarios}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>
                                            Estado
                                        </strong>
                                    </td>
                                    <td class="estado" style="background:${reporte.estado == "COMPLETADO" ? "lightgreen" : reporte.estado == "PENDIENTE" ? "gold" : "white"};">
                                        ${reporte.estado}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong>
                                            Fecha
                                        </strong>
                                    </td>
                                    <td class="fecha">
                                        ${reporte.fecha}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <br>
                        `
                            reporte.imagenes = reporte.imagenes.filter(e => e != "");
                            html_content += `
                                <div class="imagenes-seccion">
                            `
                            if (reporte.imagenes.length) {
                                html_content += `
                                    <h3>
                                        Imágenes
                                    </h3>
                                `
                                for (const img of reporte.imagenes) {
                                    html_content += `<img class="miniatura" src="${img}" data-lightbox="${img}" data-lightbox-group="${g}">`
                                }
                            } else {
                                html_content += `<span>No se agregó soporte visual.</span>`
                            }
                            html_content += `</div>`
                            html_content += `<br><br><hr><br><br>`
                        })
                        html_content += `</div>`
                    })
                    if (dev) {
                        document.getElementById("controles").style.display = ""
                    }
                    document.getElementById("main-content").innerHTML = html_content
                } catch (error) {
                    console.error(error)
                }
            }
            lightbox_load();
        };

        function descargarWordFechas() {
            swal.fire({
                willOpen: () => {
                    $("#fecha-inicio").datepicker({
                        dateFormat: 'dd/mm/yy',
                        minDate: "05/12/2022",
                        maxDate: "-1d"
                    }).bind("change", function () {
                        var minValue = $(this).val();
                        minValue = $.datepicker.parseDate("dd/mm/yy", minValue);
                        minValue.setDate(minValue.getDate() + 1);
                        $("#fecha-fin").datepicker("option", "minDate", minValue);
                    })
                    $("#fecha-fin").datepicker({ dateFormat: 'dd/mm/yy' });
                    {
                        let date = new Date(2022, 11, 5);
                        $("#fecha-inicio").datepicker("setDate", date);
                    }
                    {
                        let date = new Date();
                        $("#fecha-fin").datepicker("setDate", date);
                    }
                },
                preConfirm: () => {
                    let fini = $.datepicker.parseDate("dd/mm/yy", $("#fecha-inicio").val())
                    let ffin = $.datepicker.parseDate("dd/mm/yy", $("#fecha-fin").val())
                    fini.setHours(0, 0, 0);
                    ffin.setHours(23, 59, 59);
                    exportarWord(fini, ffin)
                },
                html: `
                    Fecha Inicio: 
                    <br>
                    <input type="text" id="fecha-inicio" class="swal2-input" style="text-align:center;">
                    <br>
                    <br>
                    Fecha fin:
                    <br>
                    <input type="text" id="fecha-fin" class="swal2-input" style="text-align:center;">
                `
            })
        }

        function exportarWord(fini, ffin) {
            let clon = document.createElement("div");
            clon.innerHTML = document.getElementById("main-content").innerHTML;
            clon.querySelectorAll(".imagenes-seccion").forEach(img => {
                clon.innerHTML = clon.innerHTML.replaceAll(img.innerHTML, "")
            });

            clon.innerHTML = clon.innerHTML.replaceAll("<br><br><hr><br><br>", "")
            clon.innerHTML = clon.innerHTML.replaceAll("<hr>", "")

            let tables = clon.querySelectorAll("table");
            tables.forEach(table => {
                let reporte = table.querySelectorAll(".reporte")[0].innerHTML;
                let caso = table.querySelectorAll(".caso")[0].innerHTML;
                let peticion = table.querySelectorAll(".peticion")[0].innerText.trim();
                let descripcion = table.querySelectorAll(".descripcion")[0].innerHTML;
                let comentarios = table.querySelectorAll(".comentarios")[0].innerHTML;
                let comentariosTEXT = table.querySelectorAll(".comentarios")[0].innerText.trim();
                let estado = table.querySelectorAll(".estado")[0].innerText.trim();
                let fecha = table.querySelectorAll(".fecha")[0].innerText.trim();

                var fecha_reporte = $("#fecha-inicio").val();
                fecha_reporte = $.datepicker.parseDate("dd/mm/yy", fecha);
                fecha_reporte.setHours(12, 0, 0);

                if (fecha_reporte < fini || fecha_reporte > ffin) {
                    return;
                }

                clon.innerHTML = clon.innerHTML.replaceAll(table.innerHTML, fecha && estado == "COMPLETADO" ? `
                <h2>
                    ${caso}
                </h2>
                <h3>
                        (${reporte}) 
                </h3>
                ${peticion != "Propia" ? "Pedido por: " + peticion : ""}
                <br>
                Finalizado el: ${fecha}
                <br>
                <br>
                ${descripcion}
                ${comentariosTEXT ? "<br><br>" + comentarios : ""}
              `: "")
            });
            clon.querySelectorAll("*").forEach(node => {
                node.style.fontFamily = "calibri";
            });
            Export2Word(clon.innerHTML, filename = 'ex.docx')
        }

        function Export2Word(HTML, filename = '') {
            let lt = `<`
            var html = `
                ${lt}html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    ${lt}head>
                        ${lt}meta charset='utf-8'>
                    ${lt}/head>
                    ${lt}body>
                ` + HTML + `
                    ${lt}/body>
                ${lt}/html>
                `;
            var blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });
            var url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
            filename = filename ? filename + '.doc' : 'document.doc';
            var downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            if (navigator.msSaveOrOpenBlob) {
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.click();
            }
            document.body.removeChild(downloadLink);
        }
    </script>